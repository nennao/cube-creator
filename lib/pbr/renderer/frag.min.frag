#version 300 es
precision highp float;
#define PI 3.1415926535897932384626433832795
uniform int u_Debug;uniform float u_EnvIntensity,u_BevelW;vec3 f(vec3 v,float u){return vec3(v.x,v.y*cos(u)-v.z*sin(u),v.y*sin(u)+v.z*cos(u));}vec3 n(vec3 v,float u){return vec3(v.z*sin(u)+v.x*cos(u),v.y,v.z*cos(u)-v.x*sin(u));}vec3 s(vec3 v,float u){return vec3(v.x*cos(u)-v.y*sin(u),v.x*sin(u)+v.y*cos(u),v.z);}vec3 f(vec3 v,float u,int z){return z==0?f(v,u):z==1?n(v,u):s(v,u);}float f(vec3 v,vec3 u,vec3 s,float z){vec3 m=v-s,f=m*m,n=m*u;float r=z*z,y=n.x+n.y+n.z,x=y*y-(f.x+f.y)-f.z+r;if(x>0.)return-y-sqrt(x);return-1.;}float n(vec3 v,vec3 u,vec3 m,float z){float i=f(v*vec3(-1,1,1),u*vec3(-1,1,1),m,z);if(i>0.)return i;i=f(v*vec3(1,-1,1),u*vec3(1,-1,1),m,z);if(i>0.)return i;i=f(v*vec3(1,1,-1),u*vec3(1,1,-1),m,z);if(i>0.)return i;return-1.;}bool s(vec3 v,vec3 u,vec3 m,vec3 z){vec3 f=1./u;float i=(m.x-v.x)*f.x,r=(z.x-v.x)*f.x,s=min(i,r),x=max(i,r);i=(m.y-v.y)*f.y;r=(z.y-v.y)*f.y;s=max(s,min(i,r));x=min(x,max(i,r));i=(m.z-v.z)*f.z;r=(z.z-v.z)*f.z;s=max(s,min(i,r));x=min(x,max(i,r));return s<=x&&x>=0.;}float f(vec3 v,vec3 u,vec3 m,float z,float i){vec3 x=1./u,f=x*v,s=abs(x)*(m+z),r=-f-s,t=-f+s,y,e,c,a,l,g;float p=max(max(r.x,r.y),r.z),w=min(min(t.x,t.y),t.z),d,R,N;if(p>w||w<0.)return-1.;d=p;y=v+d*u;e=sign(y);v*=e;u*=e;y*=e;y-=m;y=max(y.xyz,y.yzx);if(min(min(y.x,y.y),y.z)<0.)return d;c=v-m;a=u*u;l=c*c;g=c*u;R=z*z;d=1e20;N=-1.;{float P=g.x+g.y+g.z,W=l.x+l.y+l.z-R,o=P*P-W;if(o>0.)d=-P-sqrt(o),N=2.;if(i<z&&!(o>0.)){float h=n(v,u,m,z);if(h>0.)d=h,N=4.;}}{float P=a.y+a.z,W=g.y+g.z,o=l.y+l.z-R,h=W*W-P*o;if(h>0.){h=(-W-sqrt(h))/P;if(h>0.&&h<d&&abs(v.x+u.x*h)<m.x)d=h,N=3.;}}{float P=a.z+a.x,W=g.z+g.x,o=l.z+l.x-R,h=W*W-P*o;if(h>0.){h=(-W-sqrt(h))/P;if(h>0.&&h<d&&abs(v.y+u.y*h)<m.y)d=h,N=3.;}}{float P=a.x+a.y,W=g.x+g.y,o=l.x+l.y-R,h=W*W-P*o;if(h>0.){h=(-W-sqrt(h))/P;if(h>0.&&h<d&&abs(v.z+u.z*h)<m.z)d=h,N=3.;}}if(d>1e19)d=-1.;return d;}vec3 v(vec3 v,vec3 u){return sign(v)*normalize(max(abs(v)-u,0.));}float n(vec3 v,vec3 u,vec3 m,float z,float y){v-=m*y;float i=(1.-z)*.5;return z>.99?f(v,u,vec3(i),z*.5):f(v,u,vec3(i),z*.5,i);}bool s(vec3 v,vec3 u,vec3 z,vec3 m,float y){return s(v,u,z*y-.5,m*y+.5);}vec3 u(vec3 v,int u){return u==1?v.yxz:u==2?v.zyx:v;}float f(){return u_EnvIntensity>1.?.75+u_EnvIntensity*.25:u_EnvIntensity*.5+.5;}float f(mat3 v,vec3 z,vec3 m,float x,float y,float i,int s,int h){bool d=abs(i)>0.;vec3 r=u(m,s),N,g,R,l,n,a,t,W,c,e,o;float P=y-1.,w=P*.5,p=.5+y,T=.5+w,O=x*.5,b=O*(1.-O/(2.*O+P)),I,k,M,C,E,B,S,F,G,L,A,q,X,D;N=v*z;g=abs(d&&int(r.x)==h?f(N,-i,s):N);I=1.6*f();k=1.2;M=P*I;C=M*k;R=min(max(abs(g-T)-w,0.),C);E=length(M*(C-R)/C);B=(sqrt(2.)-1.)*O;S=(4.-PI)*O*O;F=length(vec2(u_BevelW))*length(vec2(u_BevelW));l=(g-T)/u_BevelW;n=vec3(max(S,F*min(1.,l.x)),max(S,F*min(1.,l.y)),max(S,F*min(1.,l.z)));a=n*I*1.5;t=a*k*1.5;W=min(max(vec3(length(g-vec3(g.x,T,T)),length(g-vec3(T,g.y,T)),length(g-vec3(T,T,g.z)))-length(vec2(B+w)),0.),t);c=vec3(t.x<=0.?0.:a.x*(t.x-W.x)/t.x,t.y<=0.?0.:a.y*(t.y-W.y)/t.y,t.z<=0.?0.:a.z*(t.z-W.z)/t.z);G=length(c);L=(P+sqrt(S))*I*k;A=u_BevelW*I*k;q=max(L,A);e=min(max(p-b-abs(N),0.),q);o=(q-e)/q;X=pow(o.x*o.x*o.x*o.x+o.y*o.y*o.y*o.y+o.z*o.z*o.z*o.z,.25);if(abs(i)>0.&&X<1.){mat3 U=mat3(1,0,0,0,1,0,0,0,1),V=mat3(1,5,5,5,1,5,5,5,1),Z=mat3(0,1,0,0,0,1,1,0,0);vec3 Y=vec3(.5+P)*V[s],Q=f(N,-i,s);float K=0.;for(int J=0;J<4;J++){vec3 H=f(Q,float(J)*PI*.5,s),j;H-=U[s]*float(h)*y;H-=vec3(p)*Z[s]+vec3(.5+P)*5.*Z[s];j=max(abs(H)-Y-b,0.);float at=clamp(1.-length(j)/q,0.,1.);K+=at*at*at*at;}K=pow(K,.25);X=max(K,X);}D=length(vec3(X,E,G));return clamp(D,0.,1.);}float f(out vec3 i,mat3 z,mat3 m,vec3 y,vec3 c,vec3 x,float r,float h,float t,int l,int e){i=c;bool a=abs(t)>0.,g;vec3 d=m*c,W=m*y,o=u(x,l),N;float P=-1.;N=vec3(0);g=false;for(int R=-1;R<2;R++){int p=o.x<0.?R:-R;vec3 T=d,S=W;if(a&&p==e)T=f(T,-t,l),S=f(S,-t,l);if(!s(S,T,u(vec3(p,-1,-1),l),u(vec3(p,1,1),l),h))continue;for(int w=-1;w<2;w++){int F=o.y<0.?w:-w;if(!s(S,T,u(vec3(p,F,-1),l),u(vec3(p,F,1),l),h))continue;for(int O=-1;O<2;O++){int C=o.z<0.?O:-O;vec3 I=u(vec3(p,F,C),l);if(distance(x,I)<.5)continue;float M=n(S,T,I,r,h);if(M>=0.&&(M<P||P<0.))P=M,N=S-I*h+M*T,g=a&&p==e;}}}if(P>=0.){vec3 T=v(N,vec3((1.-max(.001,r))*.5));if(g)T=f(T,t,l);T=normalize(z*T);i=normalize(reflect(c,T));}return P;}uniform float u_Exposure;uniform int u_Tone;uniform vec3 u_EnvColor;const float z=1./2.2;const mat3 m=mat3(.59719,.076,.0284,.35458,.90834,.13383,.04823,.01566,.83777),y=mat3(1.60475,-.10208,-.00327,-.53108,1.10813,-.07276,-.07367,-.00605,1.07602);vec3 f(vec3 v){return pow(v,vec3(z));}vec3 n(vec3 v){return vec3(pow(v.xyz,vec3(2.2)));}float s(float v){return pow(v,2.2);}vec4 u(vec4 v){return vec4(n(v.xyz),v.w);}vec3 v(vec3 v){return clamp(v*(2.51*v+.03)/(v*(2.43*v+.59)+.14),0.,1.);}vec3 x(vec3 v){vec3 u=v*(v+.0245786)-9.0537e-5,r=v*(.983729*v+.432951)+.238081;return u/r;}vec3 e(vec3 v){v=m*v;v=x(v);v=y*v;v=clamp(v,0.,1.);return v;}vec3 p(vec3 u){u*=u_Exposure;if(u_Tone==1)u=v(u);if(u_Tone==2)u=e(u);if(u_Tone==3)u/=.6,u=e(u);return f(u);}vec3 t(vec3 v){float u=v.y*.59+v.x*.3+v.z*.11;return mix(v,vec3(u),.75);}vec4 h(vec4 v){return vec4(t(v.xyz),v.w);}vec3 i(vec3 u){return u*(1.+.5*(u_EnvColor-vec3(.5)));}vec4 w(vec4 v){return vec4(i(v.xyz),v.w);}uniform int u_MipCount;uniform samplerCube u_LambertianEnvSampler,u_GGXEnvSampler;uniform sampler2D u_GGXLUT;uniform mat3 u_EnvRotation;uniform sampler2D u_NormalSampler0,u_NormalSampler1,u_NormalSampler2;uniform float u_NormalScale;in vec3 v_Position,v_PositionOrig,v_Normal,v_NormalOrig,v_Color;uniform vec3 u_BlockPositionOrig;uniform int u_NonVColor,u_ProcColor;vec3 c(vec3 v){v=v.y>v.x&&v.y>v.z?v.yxz:v.z>v.x&&v.z>v.y?v.zyx:v.xyz;v=v.z>v.y?v.xzy:v.xyz;return v;}vec3 c(){vec3 v=v_PositionOrig,u=v+u_BlockPositionOrig,f=abs(v_NormalOrig);if(f.y>f.x&&f.y>f.z)return vec3(u.x,sign(v.y)*u.z,sign(v.y)*(2./3.1));if(f.x>f.y&&f.x>f.z)return vec3(sign(v.x)*-u.z,-u.y,sign(v.x)*(9./5.3));return vec3(sign(v.z)*u.x,-u.y,sign(v.z)*(19./7.));}vec3 c(vec3 v,vec3 u){return v+u-vec3(0,0,1);}vec4 e(){vec4 v=vec4(u_NonVColor==1?vec3(1):v_Color,1);return v;}vec4 e(vec4 v,float u){return vec4(v.xyz/(1.-u*min(.4,1.-c(v.xyz).x)),v.w);}vec4 a(vec4 v){if(u_ProcColor==1){vec3 u=vec3(.08)+sin(v_PositionOrig)/10.;return vec4(normalize(u),v.w);}return v;}struct NormalInfo{vec3 ng;vec3 m;vec3 l;vec3 n;vec3 ntex;};float a(vec3 v,vec3 u){return clamp(dot(v,u),0.,1.);}uniform int u_Axis,u_Level;uniform float u_BlockR,u_Spread,u_CurrAngle;uniform int u_EnableBlocking,u_EnableBlockingAO;uniform vec3 u_BlockPosition;uniform mat4 u_RubikMatrix;uniform mat3 u_RubikMatrixInv;float a(){return s(f(u_RubikMatrixInv,v_Position,u_BlockPosition,u_BlockR,u_Spread,u_CurrAngle,u_Axis,u_Level));}float h(vec3 v,out vec3 u){return u_EnableBlocking==1?f(u,mat3(u_RubikMatrix),u_RubikMatrixInv,v_Position,v,u_BlockPosition,u_BlockR,u_Spread,u_CurrAngle,u_Axis,u_Level):-1.;}vec3 l(vec3 u){return i(t(texture(u_LambertianEnvSampler,u_EnvRotation*u).xyz))*u_EnvIntensity;}vec4 i(vec3 v,float u){return w(h(textureLod(u_GGXEnvSampler,u_EnvRotation*v,u)))*u_EnvIntensity;}vec3 a(vec3 v,vec3 u,float m,vec3 z,float x,float y){float s=a(v,u),f=m*float(u_MipCount-1),r;vec3 p=normalize(reflect(-u,v)),l=vec3(0),o,N,t;r=h(p,l);vec2 T=clamp(vec2(s,m),vec2(0),vec2(1)),g=texture(u_GGXLUT,T).xy;vec4 c=i(p,f);if(r>=0.){vec4 d=clamp(i(l,f)*(y*.75+.25),0.,y*.5+.25)*.75;c=clamp(c,0.,.75)*.75;d=mix(c,d,u_BlockR*.5+.5);c=mix(d,c,clamp(m,0.,.5)*2.*(y*.5+.5+(.5-y*.5)));}o=c.xyz;N=max(vec3(1.-m),z)-z;t=z+N*pow(1.-s,5.);return x*o*(t*g.x+g.y);}vec3 c(vec3 v,vec3 u,float z,vec3 m,vec3 x,float y){float i=a(v,u),r;vec2 f=clamp(vec2(i,z),vec2(0),vec2(1)),o=texture(u_GGXLUT,f).xy;vec3 s=l(v),N=max(vec3(1.-z),x)-x,c=x+N*pow(1.-i,5.),W=y*c*o.x+o.y,T,h,g;r=1.-o.x-o.y;T=y*(x+(1.-x)/21.);h=r*W*T/(1.-T*r);g=m*(1.-W+h);return(h+g)*s;}uniform float u_MetallicFactor,u_RoughnessFactor;uniform vec4 u_BaseColorFactor;uniform vec3 u_Camera;struct MaterialInfo{float ior;float perceptualRoughness;vec3 f0;float alphaRoughness;vec3 c_diff;vec3 f90;float metallic;vec3 baseColor;float specularWeight;};NormalInfo r(vec3 u){vec3 v=c(),f,i,z,m,r,y,x,l,g,t,s;vec2 h=v.xy;f=dFdx(vec3(h,0));i=dFdy(vec3(h,0));if(length(f)+length(i)<=1e-6)f=vec3(1,0,0),i=vec3(0,1,0);z=(i.y*dFdx(v_Position)-f.y*dFdy(v_Position))/(f.x*i.y-i.x*f.y);x=normalize(v_Normal);r=normalize(z-x*dot(x,z));y=cross(x,r);if(gl_FrontFacing==false)r*=-1.,y*=-1.,x*=-1.;NormalInfo o;o.ng=x;float P=v.z,N;l=normalize(texture(u_NormalSampler0,h/3.+P).xyz*2.-1.);g=normalize(texture(u_NormalSampler1,h/4.3+P).xyz*2.-1.);t=normalize(texture(u_NormalSampler2,h/7.+P*3.).xyz*2.-1.);l.x*=abs(l.x)<.05?.5:1.;l.y*=abs(l.y)<.05?.5:1.;g.x*=abs(g.x)<.075?.25:1.;g.y*=(abs(g.y)<.075?.25:1.)*-1.;t.x*=abs(t.x)<.1?.5:1.;t.y*=abs(t.y)<.1?.5:1.;s=vec3(0,0,1);s=c(s,l);s=c(s,g);s=c(s,t);s=normalize(clamp(s,-1.,1.));N=u_NormalScale*u_NormalScale;o.ntex=normalize(s*vec3(N,N,1));o.n=normalize(mat3(r,y,x)*o.ntex);o.m=r;o.l=y;return o;}vec4 h(){vec4 v=vec4(1);v=u_BaseColorFactor;v=a(v);return u(e(v*e(),u_MetallicFactor));}MaterialInfo d(MaterialInfo v){v.metallic=u_MetallicFactor;v.perceptualRoughness=u_RoughnessFactor;v.c_diff=mix(v.baseColor.xyz,vec3(0),v.metallic);v.f0=mix(v.f0,v.baseColor.xyz,v.metallic);return v;}out vec4 g_finalColor;void main(){vec4 v=h();v.w=1.;vec3 u=normalize(u_Camera-v_Position),i,y,m,z,s;NormalInfo o=r(u);i=o.n;MaterialInfo l;l.baseColor=v.xyz;l.ior=1.5;l.f0=vec3(.04);l.specularWeight=1.;l=d(l);l.perceptualRoughness=clamp(l.perceptualRoughness,0.,1.);l.metallic=clamp(l.metallic,0.,1.);l.alphaRoughness=l.perceptualRoughness*l.perceptualRoughness;l.f90=vec3(1);y=vec3(0);m=vec3(0);y+=a(i,u,l.perceptualRoughness,l.f0,l.specularWeight,l.metallic);m+=c(i,u,l.perceptualRoughness,l.c_diff,l.f0,l.specularWeight);float e=u_EnableBlockingAO==1?a():1.;y*=e;m*=e;z=m+y;switch(u_Debug){case 1:s=f(v.xyz);break;default:s=p(z);}g_finalColor=vec4(s,v.w);}